# ESAM - Простая система управления учетными записями SSH

## Предназначение

Используется для создания учетных записей пользователей на управляемых узлах, настройки для этих учетных записей доступа по SSH и удобного поиска и подключения к управляемым узлам с рабочего места пользователя

## Особенности

* все данные всех пользователей подписывается ключом проверки или ключом другого пользователя чьи данные в свою очередь также подписываются ключом проверки и т.д. Агенты, непосредственно настраивающие учетные записи на управляемых узлах, проверяют аутентичность полученных данных и настраивают только те учетные записи данные которых проходят проверки. Это усложняет создание учетных записей на управляемых узлах злоумышленником получившим несанкционированный доступ к БД

* Клиенты, используемые пользователями для управления системой и подключения к управляемым узлам по SSH, также проверяют аутентичность полученных данных, в том числе данных об управляемых узлах. К тому же Клиенты кэшируют проверенные данные об управляемых узлах и обеспечивают быстрый поиск управляемых узлов с автодополнением

## Компоненты

* Директор (`esamd`) - хранит данные пользователей и управляемых узлов, отвечает на запросы Клиентов и Агентов

* Клиент (`esamc`) - позволяет изменять данные пользователей и управляемых узлов, получает у Директора списки пользователей и управляемых узлов, проверяет полученные данные и кэширует их

* Агент (`esama`) - получает у Директора списки пользователей, проверяет полученные данные и настраивает учетные записи на узле

## Права доступа

Роли пользователей:

* Владелец - может изменять данные всех пользователей (кроме другого Владельца) и управляемых узлов

* Администратор безопасности - может изменять данные Инженеров и управляемых узлов

* Инженер - не может изменять данные пользователей и управляемых узлов

Все пользователи могут получать списки пользователей и управляемых узлов, а также изменять свой пароль используемый для повышения привилегий на управляемых узлах

Агенты могут только получать списки пользователей

Иерархия ролей пользователей также принимается во внимание при выполнении проверок аутентичности данных:

* данные Инженера могут быть подписаны только Администратором безопасности, Владельцем или ключом проверки

* данные Администратора безопасности могут быть подписаны только Владельцем или ключом проверки

* данные Владельца могут быть подписаны только ключом проверки

* данные управляемого узла могут быть подписаны только Администратором безопасности, Владельцем или ключом проверки

## Быстрый старт

* создать БД (узел с Директором):

```bash
esamd init-db
```

* запустить Директор (узел с Директором):

```bash
esamd start --listen-addr 127.0.0.1 --listen-port 32000 --tls-key tls-key --tls-cert tls-cert
```

* сгенерировать пару закрытого и открытого ключей проверки аутентичности данных (рабочая станция Владельца):

```bash
esamc gen-key --esam-key verify-key --esam-pub-key verify-pub-key
```

* сгенерировать пару закрытого и открытого ключей Владельца (рабочая станция Владельца):

```bash
esamc gen-key --esam-key esam-key --esam-pub-key esam-pub-key
```

* отправить запрос на доступ (рабочая станция Владельца):

```bash
esamc send-access-req --esam-pub-key esam-pub-key --name owner --dir-addr 127.0.0.1 --dir-port 32000
```

* добавить Владельца без подписи данных (узел с Директором):

```bash
esamc add-user --dir-uds-path esamd.socket
```

* подключиться к Директору как Владелец (рабочая станция Владельца):

```bash
esamc login --esam-key esam-key --dir-addr 127.0.0.1 --dir-port 32000  --verify-key verify-pub-key
```

* подписать данные Владельца ключом проверки (рабочая станция Владельца):

```bash
esamc update-user --name owner --sign-key verify-key
```

Теперь можно добавлять / изменять других пользователей используя только ключ Владельца, без необходимости использовать опцию `--sign-key` и ключ проверки

* запустить Агента, автоматически будут сгенерированы его ключи и отправлен запрос на доступ (управляемый узел):

```bash
esama start --esam-key esama-key --dir-addr 127.0.0.1 --dir-port 32000 --verify-key verify-pub-key
```

* добавить управляемый узел (рабочая станция Владельца):

```bash
esamc add-node
```

Теперь можно подключиться к управляемому узлу (рабочая станция Владельца):

```bash
esamc ssh node-1
```
