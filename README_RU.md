# ESAM - Простая система управления учетными записями SSH

## Предназначение

Используется для создания учетных записей пользователей на управляемых узлах, настройки для этих учетных записей доступа по SSH и удобного подключения к управляемым узлам с рабочих мест пользователей

## Особенности

* Применяется криптографическая защита аутентичности данных хранящихся в БД, которая усложняет создание учетных записей пользователей на управляемых узлах злоумышленником, получившим несанкционированный доступ к БД. Все данные всех пользователей и управляемых узлов подписываются ключом проверки или ключом пользователя чьи данные, в свою очередь, также подписываются ключом проверки или ключом другого пользователя и т.д. Агенты, непосредственно настраивающие учетные записи пользователей на управляемых узлах, проверяют аутентичность полученных данных и настраивают только те учетные записи данные которых успешно проходят проверки на аутентичность

* Применяется кэширование данных об управляемых узлах на рабочих станциях пользователей, позволяющее подключаться к управляемым узлам без сетевого доступа к БД. Кэшируемые данные также предварительно проходят проверки на их аутентичность

* Применяется уведомление об изменении данных в БД, позволяющее оперативно (пере-)настраивать учетные записи пользователей и подключаться к управляемым узлам с актуальными параметрами подключения

## Компоненты

* Директор (`esamd`) - хранит данные о пользователях и управляемых узлах, отвечает на запросы Клиентов и Агентов

* Клиент (`esamc`) - позволяет изменять данные пользователей и управляемых узлов, получает у Директора данные о пользователях и управляемых узлах, проверяет полученные данные и кэширует их. Обеспечивает быстрое подключение к управляемым узлам по SSH

* Агент (`esama`) - получает у Директора данные о пользователях, проверяет полученные данные и настраивает учетные записи пользователей на управляемом узле

## Права доступа

Роли пользователей:

* Владелец - может изменять данные всех пользователей (кроме другого Владельца) и управляемых узлов

* Администратор безопасности - может изменять данные Инженеров и управляемых узлов

* Инженер - не может изменять данные пользователей и управляемых узлов

Все пользователи могут получать данные о пользователях и управляемых узлах, а также изменять свой пароль, используемый для повышения привилегий на управляемых узлах

Агенты могут только получать данные о пользователях

Иерархия ролей пользователей также принимается во внимание при выполнении проверок аутентичности данных:

* данные Инженера могут быть подписаны только Администратором безопасности, Владельцем или ключом проверки

* данные Администратора безопасности могут быть подписаны только Владельцем или ключом проверки

* данные Владельца могут быть подписаны только ключом проверки

* данные управляемого узла могут быть подписаны только Администратором безопасности, Владельцем или ключом проверки

## Быстрый старт

* создать БД (узел с Директором):
  ```bash
  esamd init-db
  ```

* запустить Директор (узел с Директором):
  ```bash
  esamd start --listen-addr 127.0.0.1 --listen-port 32000 --tls-key tls-key --tls-cert tls-cert
  ```

* сгенерировать пару закрытого и открытого ключей проверки аутентичности данных (рабочая станция Владельца):
  ```bash
  esamc gen-key --esam-key verify-key --esam-pub-key verify-pub-key
  ```

* сгенерировать пару закрытого и открытого ключей Владельца (рабочая станция Владельца):
  ```bash
  esamc gen-key --esam-key esam-key --esam-pub-key esam-pub-key
  ```

* отправить запрос на доступ (рабочая станция Владельца):
  ```bash
  esamc send-access-req --esam-pub-key esam-pub-key --name owner --dir-addr 127.0.0.1 --dir-port 32000
  ```

* добавить Владельца без подписи его данных, через Unix-сокет используемый для локального управления Директором (узел с Директором):
  ```bash
  esamc add-user --dir-uds-path esamd.socket
  ```

* подключиться к Директору как Владелец (рабочая станция Владельца):
  ```bash
  esamc login --esam-key esam-key --dir-addr 127.0.0.1 --dir-port 32000  --verify-key verify-pub-key
  ```

* подписать данные Владельца ключом проверки (рабочая станция Владельца):
  ```bash
  esamc update-user --name owner --sign-key verify-key
  ```

Теперь можно добавлять пользователей и управляемые узлы используя только ключ Владельца, без необходимости использовать опцию `--sign-key` и ключ проверки

* запустить Агента, автоматически будут сгенерированы его ключи и отправлен запрос на доступ (управляемый узел):
  ```bash
  esama start --esam-key esama-key --dir-addr 127.0.0.1 --dir-port 32000 --verify-key verify-pub-key
  ```

* добавить управляемый узел (рабочая станция Владельца):
  ```bash
  esamc add-node
  ```

Теперь можно подключиться к управляемому узлу (рабочая станция Владельца):

```bash
esamc ssh node-1
```
